/* Core JS */
debug = true;
var command__last, manual__last;
var cekFirst = false;
var from_command = false;
var from_command_c = 0;
var dialog = document.querySelector('#nyan-dialog');

function appsLoad() {
    checkCookie();
    document.getElementById('list__device').innerHTML = localStorage.getItem("lastDeviceList");
    isBrowserChrome();
    setdebug("Apps ready!");
}

function isBrowserChrome() {
    var getBrowserVendor = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
    if (getBrowserVendor) {
        if (!('webkitSpeechRecognition' in window)) {
            $('#apps-login-form').addClass("disable");
            $('#overlay').addClass("disable");
            $('dialog').addClass("show");
            setdebug("Browser is not support!");
        }
        setdebug("Browser is Chrome!");
    } else {
        $('#apps-login-form').addClass("disable");
        $('#overlay').addClass("disable");
        $('dialog').addClass("show");
        showToast(navigator.userAgent);
        setdebug("Browser is Not Chrome");
    }
}
(function() {
    'use strict';
    window['counter'] = 0;
    var snackbarContainer = document.querySelector('#demo-show-toast');
    var showToastButton = document.querySelector('#apps-button-help');
    showToastButton.addEventListener('click', function() {
        'use strict';
        var data = {
            message: 'Masukkan ID Device dan Password'
        };
        snackbarContainer.MaterialSnackbar.showSnackbar(data);
    }, false);
}());

function openMainPages() {
    getDevice();
    document.getElementById('login-pages').style.display = 'none';
    document.getElementById('main-pages').style.display = 'block';
    showToast("Login Successfuly")
    setdebug("Login Successfuly");
}

function doLogin() {
    var iddevice = $("#deviceid").val();
    var passwd = $('#password').val();
    var form = new FormData();
    form.append("id", iddevice);
    form.append("passwd", passwd);
    if (iddevice != "" && passwd != "") {
        var settings = {
            "async": true,
            "crossDomain": true,
            "url": "http://api.stkip-jbg.com/TalkToNyanAPI/api/auth",
            "method": "POST",
            "processData": false,
            "contentType": false,
            "headers": {
                'X-Requested-With': 'XMLHttpRequest'
            },
            "mimeType": "multipart/form-data",
            "data": form
        }
        $.ajax(settings).done(function(response) {
            var status = response;
            if (status == "allowed") {
                setCookie("deviceID", iddevice, 30);
                setdebug("Login Successfuly with ID " + iddevice);
                openMainPages();
            } else if (status == "denied") {
                showToast("Login Error! - Periksa Username dan Password");
                setdebug("Login Error! - Periksa Username dan Password | username : " + iddevice);
            } else {
                showToast("Internal Server Error!");
                setdebug("Internal Server Error! - Error : " + status).substring(1, 20);
            }
        }).fail(function(jqXHR, textStatus, errorThrown) {
            showToast("Internal Server Error!");
            setdebug("Error ketika Request ke Server! - Tunggu beberapa saat lagi");
        });
    } else {
        showToast("Masukkan ID Device dan Password");
    }
}

function doLogout() {
    var user = getCookie("deviceID");
    setdebug("User " + user + " sedang prosess Logout");
    deleteCookie("deviceID");
    checkCookie();
    setdebug("User " + user + " berhasil Logout");
    showToast("Logout Successfuly");
}

function showToast(datanya) {
    var snackbarContainer = document.querySelector('#demo-show-toast');
    var showToastButton = document.querySelector('#apps-button-help');
    var data = {
        message: datanya
    };
    snackbarContainer.MaterialSnackbar.showSnackbar(data);
}

function setdebug(datalog) {
    var date = new Date();
    if (window.debug == true) {
        console.log(date + " - " + datalog);
    }
}

function getDevice() {
    var start_time = new Date().getTime();
    var listDevice__manual = '';
    $.ajax({
        type: 'GET',
        url: 'http://api.stkip-jbg.com/TalkToNyanAPI/api/status/' + getCookie("deviceID") + '/json',
        dataType: 'json',
        success: function(data) {
            var hasil = data.status.length + " Perangkat Tersedia";
            var listDevice = "";
            var namaDevice = data.device.name;
            for (i = 0; i < data.status.length; i++) {
                var dataJsonTime = data.devicetime[i].time;
                var dataJsonStatus = data.status[i];
                var statusDevice = dataJsonStatus.status;
                var nameDevice = dataJsonStatus.name;
                var typeDevice = dataJsonStatus.devicetype;
                if (typeDevice == "ac") {
                    var suhuDevice = dataJsonStatus.suhu;
                    typeDevice = "wb_iridescent";
                    nameDevice = nameDevice + " ( #" + dataJsonStatus.id + " )";
                    if (statusDevice == "1") {
                        statusDevice = "Menyala sejak " + dataJsonTime + " - Suhu Terakhir " + suhuDevice + "&deg;C";
                        var anotherStatusDevice = "offline_pin";
                        var onoroff = "device-on-icon";
                    } else {
                        statusDevice = "Mati sejak " + dataJsonTime + " - Suhu Terakhir " + suhuDevice + "&deg;C";
                        var anotherStatusDevice = "power_settings_new";
                        var onoroff = "device-off-icon";
                    }
                } else if (typeDevice == "lampu") {
                    typeDevice = "wb_incandescent";
                    nameDevice = nameDevice + " ( #" + dataJsonStatus.id + " )";
                    if (statusDevice == "1") {
                        statusDevice = "Menyala sejak " + dataJsonTime;
                        var anotherStatusDevice = "offline_pin";
                        var onoroff = "device-on-icon";
                    } else {
                        statusDevice = "Mati sejak " + dataJsonTime;
                        var anotherStatusDevice = "power_settings_new";
                        var onoroff = "device-off-icon";
                    }
                }
                listDevice += "<li class='mdl-list__item mdl-list__item--three-line'><span class='mdl-list__item-primary-content'><i class='material-icons mdl-list__item-avatar icon-avatar " + onoroff + "' style='transform: rotate(180deg);'>" + typeDevice + "</i><span>" + nameDevice + "</span><span class='mdl-list__item-text-body'>" + statusDevice + "</span></span><span class='mdl-list__item-secondary-content'><a class='mdl-list__item-secondary-action' href='#'><i class='material-icons'>" + anotherStatusDevice + "</i></a></span></li>";;
                setdebug(data.lastcommand[0].id + ' - ' + manual__last);
            }

            for (i = 0; i < data.status.length; i++) {
              if (cekFirst) {
                    var statusT = '';
                    if (statusDevice == '1') {
                      statusT = 'checked';
                    } 
                    var indx = i + 1;
                    var items__dom = '<input class="mdl-switch__input" id="switch-'+indx+'" type="checkbox" '+statusT+' devicename="'+data.status[i].name.toLowerCase()+'"><span class="mdl-switch__label"></span></input>';
                    $('#switch-' + indx + '__DOM').html(items__dom);
                    console.log(items__dom);
                    cekFirst = false;
              }
              if ((data.lastcommand[0].id != manual__last) && (cekFirst == true))  {
                    var statusT = '';
                    if (statusDevice == '1') {
                      statusT = 'checked';
                    } 
                    var indx = i + 1;
                    var items__dom = '<input class="mdl-switch__input" id="switch-'+indx+'" type="checkbox" '+statusT+' devicename="'+data.status[i].name.toLowerCase()+'"><span class="mdl-switch__label"></span></input>';
                    $('#switch-' + indx + '__DOM').html(items__dom);
                    console.log(items__dom);
                    manual__last = data.lastcommand[0].id;
              }
            };
            var request_time = new Date().getTime() - start_time;
            if (request_time > 1000) {
                request_time = request_time % 60;
                request_time = request_time + ' s';
            } else {
                request_time = request_time + ' ms';
            }
            setdebug("Data Device dari API success - " + request_time);
            document.getElementById('deviceavailable').innerHTML = hasil;
            localStorage.setItem("lastDeviceList", listDevice);
            document.getElementById('list__device').innerHTML = listDevice;
            document.getElementById('devicename').innerHTML = namaDevice;
            setTimeout(function() {
                getDevice();
            }, 3000);
            if (from_command && (data.lastcommand[0].id != command__last)) {
                setdebug(data.lastcommand[0].id + ' - ' + command__last)
                if ((from_command_c == 1)) {
                    var items, action;
                    if (data.lastcommand[0].name == 'AC') {
                        items = "Pendingin Ruangan";
                    } else {
                        items = data.lastcommand[0].name;
                    }
                    if (data.lastcommand[0].action == 'MEMATIKAN') {
                        action = "dimatikan";
                    } else if (data.lastcommand[0].action == 'MENYALAKAN') {
                        action = "dinyalakan";
                    }
                    responsiveVoice.speak(items + ", sudah " + action, "Indonesian Female");
                    from_command = false;
                    from_command_c = 0;
                    command__last = data.lastcommand[0].id;
                } else {
                    from_command_c++;
                }
            }
            
        }
    });
}
var dialog__manual = document.querySelector('.dialog__manual');
var showDialogButton = document.querySelector('#manual-button');
if (!dialog__manual.showModal) {
    dialogPolyfill.registerDialog(dialog__manual);
}
$('#manual-button').click(function() {
    $('.dialog__manual').addClass("show");
});
$('.dialog__manual .close').click(function() {
    $('.dialog__manual').removeClass("show");
});


$( "#switch-1" ).change(function () {
  var state = $('#switch-1').is(':checked');
  if (state) {
    sendManual($( "#switch-1" ).attr('devicename'), 'nyalakan');
  } else {
    sendManual($( "#switch-1" ).attr('devicename'), 'matikan');
  }
});

function sendManual(device, action) {
    $.ajax({ 
      type: 'GET', 
      url: "http://api.stkip-jbg.com/TalkToNyanAPI/api/prosess/" + getCookie("deviceID") + "/" + encodeURI(action + ' ' + device),
      headers: {
          'X-Requested-With': 'XMLHttpRequest'
      },
      success:function(data) {
         setdebug('Manual Action device ' + device);
      }
    });
    from_command = true;
}
/* 

    Cookies Engine 

*/
function getCookie(c_name) {
    var c_value = document.cookie;
    var c_start = c_value.indexOf(" " + c_name + "=");
    if (c_start == -1) {
        c_start = c_value.indexOf(c_name + "=");
    }
    if (c_start == -1) {
        c_value = null;
    } else {
        c_start = c_value.indexOf("=", c_start) + 1;
        var c_end = c_value.indexOf(";", c_start);
        if (c_end == -1) {
            c_end = c_value.length;
        }
        c_value = unescape(c_value.substring(c_start, c_end));
    }
    return c_value;
}

function setCookie(c_name, value, exdays) {
    // Example setCookie("username",username,365);
    var exdate = new Date();
    exdate.setDate(exdate.getDate() + exdays);
    var c_value = escape(value) + ((exdays == null) ? "" : "; expires=" + exdate.toUTCString());
    document.cookie = c_name + "=" + c_value;
}

function checkCookie() {
    var username = getCookie("deviceID");
    if (username != null && username != "") {
        setdebug("Device ID " + username);
        document.getElementById('login-pages').style.display = 'none';
        document.getElementById('main-pages').style.display = 'block';
        getDevice();
        cekFirst = true;
    } else {
        document.getElementById('login-pages').style.display = 'block';
        document.getElementById('main-pages').style.display = 'none';
    }
}

function deleteCookie(key) {
    document.cookie = key + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
}